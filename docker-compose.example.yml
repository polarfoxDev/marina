version: '3.8'

services:
  # Marina backup orchestrator
  marina:
    image: ghcr.io/polarfoxdev/marina:latest
    # build: .
    container_name: marina
    restart: unless-stopped
    volumes:
      # Docker socket access for discovery and container control
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Volume root for direct filesystem access
      - /var/lib/docker/volumes:/var/lib/docker/volumes:ro
      # Staging directory for DB dumps (must be writable)
      - marina-staging:/backup/tmp
      # Configuration file
      - ./config.yml:/app/config.yml:ro
    environment:
      # Environment variables that can be referenced in config.yml
      # using ${VAR_NAME} or $VAR_NAME syntax
      RESTIC_PASSWORD: "${RESTIC_PASSWORD}"
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
      DO_SPACES_KEY: "${DO_SPACES_KEY}"
      DO_SPACES_SECRET: "${DO_SPACES_SECRET}"
      # Marina runtime configuration
      CONFIG_FILE: "/app/config.yml"
      VOLUME_ROOT: "/var/lib/docker/volumes"
      STAGING_DIR: "/backup/tmp"
    networks:
      - backup-net

  # Example: PostgreSQL database with backup labels
  postgres:
    image: postgres:16-alpine
    container_name: app-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: myapp
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      # Required for pg_dumpall to authenticate
      PGPASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # Mount staging dir for dumps (Marina will exec inside this container)
      - marina-staging:/backup/tmp
    labels:
      # Enable Marina backup for this DB container
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.db: "postgres"
      eu.polarnight.marina.schedule: "30 2 * * *"  # 2:30 AM daily (overrides default)
      eu.polarnight.marina.instanceID: "hetzner-s3"
      eu.polarnight.marina.retention: "7d:4w:6m"  # 7 daily, 4 weekly, 6 monthly
      eu.polarnight.marina.tags: "service:postgres,env:production"
      # Optional: custom pg_dumpall arguments (--all-databases is default)
      # eu.polarnight.marina.dump.args: "--clean,--if-exists"
      # Optional: pre/post hooks for consistency
      eu.polarnight.marina.pre: "psql -U myapp -c 'CHECKPOINT;'"
      eu.polarnight.marina.post: "echo 'Backup completed'"
    networks:
      - backup-net
      - app-net

  # Example: MySQL database with backup labels
  mysql:
    image: mysql:8.4
    container_name: app-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: myapp
      # Required for mysqldump to authenticate without password prompt
      MYSQL_PWD: "${MYSQL_ROOT_PASSWORD}"
    volumes:
      - mysql-data:/var/lib/mysql
      - marina-staging:/backup/tmp
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.db: "mysql"
      eu.polarnight.marina.schedule: "30 2 * * *"
      eu.polarnight.marina.instanceID: "hetzner-s3"
      eu.polarnight.marina.retention: "7d:4w:6m"
      eu.polarnight.marina.tags: "service:mysql,env:production"
      # Optional: custom mysqldump arguments (--all-databases is default)
      # eu.polarnight.marina.dump.args: "--routines,--triggers"
    networks:
      - backup-net
      - app-net

  # Example: MariaDB database with backup labels
  mariadb:
    image: mariadb:11
    container_name: app-mariadb
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      MARIADB_DATABASE: myapp
      # Required for mariadb-dump to authenticate without password prompt
      MYSQL_PWD: "${MARIADB_ROOT_PASSWORD}"
    volumes:
      - mariadb-data:/var/lib/mysql
      - marina-staging:/backup/tmp
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.db: "mariadb"
      eu.polarnight.marina.schedule: "30 2 * * *"
      eu.polarnight.marina.instanceID: "hetzner-s3"
      eu.polarnight.marina.retention: "7d:4w:6m"
      eu.polarnight.marina.tags: "service:mariadb,env:production"
      # Optional: custom mariadb-dump arguments (--all-databases is default)
      # eu.polarnight.marina.dump.args: "--routines,--triggers"
    networks:
      - backup-net
      - app-net

  # Example: Application with volume backup
  app:
    image: myapp:latest
    container_name: myapp
    restart: unless-stopped
    volumes:
      - app-uploads:/app/uploads
      - app-config:/app/config
    depends_on:
      - postgres
    networks:
      - app-net

volumes:
  # Marina staging directory for DB dumps
  marina-staging:
    driver: local

  # PostgreSQL data volume (backed up via DB dump, not volume backup)
  postgres-data:
    driver: local

  # MySQL data volume (backed up via DB dump, not volume backup)
  mysql-data:
    driver: local

  # MariaDB data volume (backed up via DB dump, not volume backup)
  mariadb-data:
    driver: local

  # Application uploads volume with backup labels
  app-uploads:
    driver: local
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.schedule: "0 3 * * *"  # 3:00 AM daily
      eu.polarnight.marina.instanceID: "hetzner-s3"
      eu.polarnight.marina.retention: "14d:8w:12m"  # Keep more for user data
      eu.polarnight.marina.paths: "/"
      eu.polarnight.marina.stopAttached: "true"  # Stop app container during backup
      eu.polarnight.marina.tags: "type:uploads,env:production"
      eu.polarnight.marina.exclude: "*.tmp,cache/*,thumbnails/*"

  # Application config volume - uses defaults from config.yml
  # If config.yml has defaultSchedule, defaultRetention, defaultStopAttached,
  # those will be used unless overridden by labels here
  app-config:
    driver: local
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.instanceID: "hetzner-s3"
      # No schedule: uses defaultSchedule from config.yml (or "0 3 * * *" if not set)
      # No retention: uses defaultRetention from config.yml (or "7d:4w:6m" if not set)
      # No stopAttached: uses defaultStopAttached from config.yml (or false if not set)
      eu.polarnight.marina.paths: "/"
      eu.polarnight.marina.tags: "type:config,env:production"

networks:
  backup-net:
    driver: bridge
  app-net:
    driver: bridge
