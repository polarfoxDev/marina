services:
  # Marina backup orchestrator
  marina:
    image: ghcr.io/polarfoxdev/marina:latest
    # build: .
    container_name: marina
    restart: unless-stopped
    volumes:
      # Docker socket access for discovery and container control
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Staging directory for DB dumps and volume copies (must be writable)
      - marina-staging:/backup
      # Persistent data directory for logs and status database
      - marina-data:/var/lib/marina
      # Configuration file
      - ./config.yml:/app/config.yml:ro
    ports:
      # Expose API server for status queries and future web UI
      - "8080:8080"
    environment:
      # Environment variables that can be referenced in config.yml
      # using ${VAR_NAME} or $VAR_NAME syntax
      RESTIC_PASSWORD: "${RESTIC_PASSWORD}"
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
      DO_SPACES_KEY: "${DO_SPACES_KEY}"
      DO_SPACES_SECRET: "${DO_SPACES_SECRET}"
      # Marina runtime configuration
      CONFIG_FILE: "/app/config.yml"
      DB_PATH: "/var/lib/marina/marina.db"
      API_PORT: "8080"
      NODE_NAME: "${HOSTNAME}"
    networks:
      - backup-net

  # Example: PostgreSQL database with backup labels
  postgres:
    image: postgres:16-alpine
    container_name: app-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: myapp
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      # Required for pg_dumpall to authenticate
      PGPASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    labels:
      # Enable Marina backup for this DB container
      dev.polarfox.marina.enabled: "true"
      dev.polarfox.marina.db: "postgres"
      dev.polarfox.marina.instanceID: "hetzner-s3"
      dev.polarfox.marina.retention: "7d:4w:6m"  # 7 daily, 4 weekly, 6 monthly
      dev.polarfox.marina.tags: "service:postgres,env:production"
      # Optional: custom pg_dumpall arguments (--all-databases is default)
      # dev.polarfox.marina.dump.args: "--clean,--if-exists"
      # Optional: pre/post hooks for consistency
      dev.polarfox.marina.pre: "psql -U myapp -c 'CHECKPOINT;'"
      dev.polarfox.marina.post: "echo 'Backup completed'"
    networks:
      - backup-net
      - app-net

  # Example: MySQL database with backup labels
  # Example: MySQL database with backup labels
  mysql:
    image: mysql:8.4
    container_name: app-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: myapp
    volumes:
      - mysql-data:/var/lib/mysql
    labels:
      dev.polarfox.marina.enabled: "true"
      dev.polarfox.marina.db: "mysql"
      dev.polarfox.marina.instanceID: "hetzner-s3"
      dev.polarfox.marina.retention: "7d:4w:6m"
      dev.polarfox.marina.tags: "service:mysql,env:production"
      # Pass credentials via dump args (note: no spaces after commas)
      dev.polarfox.marina.dump.args: "-uroot,-p${MYSQL_ROOT_PASSWORD}"
    networks:
      - backup-net
      - app-net

  # Example: MariaDB database with backup labels
  mariadb:
    image: mariadb:11
    container_name: app-mariadb
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      MARIADB_DATABASE: myapp
    volumes:
      - mariadb-data:/var/lib/mysql
    labels:
      dev.polarfox.marina.enabled: "true"
      dev.polarfox.marina.db: "mariadb"
      dev.polarfox.marina.instanceID: "hetzner-s3"
      dev.polarfox.marina.retention: "7d:4w:6m"
      dev.polarfox.marina.tags: "service:mariadb,env:production"
      # Pass credentials via dump args (note: no spaces after commas)
      dev.polarfox.marina.dump.args: "-uroot,-p${MARIADB_ROOT_PASSWORD}"
      # Optional: custom mariadb-dump arguments (--all-databases is default)
      # dev.polarfox.marina.dump.args: "--routines,--triggers"
    networks:
      - backup-net
      - app-net

  # Example: Application with volume backup
  app:
    image: myapp:latest
    container_name: myapp
    restart: unless-stopped
    volumes:
      - app-uploads:/app/uploads
      - app-config:/app/config
    depends_on:
      - postgres
    networks:
      - app-net

volumes:
  # Marina staging directory for DB dumps
  marina-staging:
    driver: local

  # PostgreSQL data volume (backed up via DB dump, not volume backup)
  postgres-data:
    driver: local

  # MySQL data volume (backed up via DB dump, not volume backup)
  mysql-data:
    driver: local

  # MariaDB data volume (backed up via DB dump, not volume backup)
  mariadb-data:
    driver: local

  # Application uploads volume with backup labels
  app-uploads:
    driver: local
    labels:
      dev.polarfox.marina.enabled: "true"
      dev.polarfox.marina.instanceID: "hetzner-s3"
      dev.polarfox.marina.retention: "14d:8w:12m"  # Keep more for user data
      dev.polarfox.marina.paths: "/"
      dev.polarfox.marina.stopAttached: "true"  # Stop app container during backup
      dev.polarfox.marina.tags: "type:uploads,env:production"
      dev.polarfox.marina.exclude: "*.tmp,cache/*,thumbnails/*"

  # Application config volume - minimal labels (uses instance schedule and default retention)
  app-config:
    driver: local
    labels:
      dev.polarfox.marina.enabled: "true"
      dev.polarfox.marina.instanceID: "hetzner-s3"
      # Schedule comes from instance config in config.yml
      # Retention: uses 7d:4w:6m default if not specified
      # stopAttached: defaults to false
      dev.polarfox.marina.paths: "/"
      dev.polarfox.marina.tags: "type:config,env:production"

networks:
  backup-net:
    driver: bridge
  app-net:
    driver: bridge

# Note: Marina uses two volumes:
# - marina-staging: temporary storage for backup preparation (DB dumps, volume copies)
# - marina-data: persistent storage for marina.db (unified database for logs and job status)
