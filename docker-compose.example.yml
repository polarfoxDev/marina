version: '3.8'

services:
  # Marina backup orchestrator
  marina:
    image: ghcr.io/polarfoxdev/marina:latest
    # build: .
    container_name: marina
    restart: unless-stopped
    volumes:
      # Docker socket access for discovery and container control
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Volume root for direct filesystem access
      - /var/lib/docker/volumes:/var/lib/docker/volumes:ro
      # Staging directory for DB dumps (must be writable)
      - marina-staging:/backup/tmp
      # Configuration file
      - ./config.yml:/app/config.yml:ro
    environment:
      # Restic repository configuration (will be replaced by config.yml parsing)
      RESTIC_REPOSITORY: "s3:https://s3.eu-central-1.amazonaws.com/my-backup-bucket"
      RESTIC_PASSWORD: "${RESTIC_PASSWORD}"
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
      AWS_DEFAULT_REGION: "eu-central-1"
      # Marina configuration
      VOLUME_ROOT: "/var/lib/docker/volumes"
      STAGING_DIR: "/backup/tmp"
    networks:
      - backup-net

  # Example: PostgreSQL database with backup labels
  postgres:
    image: postgres:16-alpine
    container_name: app-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: myapp
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # Mount staging dir for dumps (Marina will exec inside this container)
      - marina-staging:/backup/tmp
    labels:
      # Enable Marina backup for this DB container
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.db: "postgres"
      eu.polarnight.marina.schedule: "30 2 * * *"  # 2:30 AM daily
      eu.polarnight.marina.destination: "hetzner-s3"
      eu.polarnight.marina.retention: "7d:4w:6m"  # 7 daily, 4 weekly, 6 monthly
      eu.polarnight.marina.tags: "service:postgres,env:production"
      eu.polarnight.marina.dump.args: "--clean,--if-exists,--no-owner,--no-acl"
      # Optional: pre/post hooks for consistency
      eu.polarnight.marina.pre: "psql -U myapp -c 'CHECKPOINT;'"
      eu.polarnight.marina.post: "echo 'Backup completed'"
    networks:
      - backup-net
      - app-net

  # Example: Application with volume backup
  app:
    image: myapp:latest
    container_name: myapp
    restart: unless-stopped
    volumes:
      - app-uploads:/app/uploads
      - app-config:/app/config
    depends_on:
      - postgres
    networks:
      - app-net

  # Example: Redis with DB backup
  redis:
    image: redis:7-alpine
    container_name: app-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
      - marina-staging:/backup/tmp
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.db: "redis"
      eu.polarnight.marina.schedule: "0 4 * * *"  # 4:00 AM daily
      eu.polarnight.marina.destination: "hetzner-s3"
      eu.polarnight.marina.retention: "7d:4w:3m"
      eu.polarnight.marina.tags: "service:redis,env:production"
    networks:
      - backup-net
      - app-net

volumes:
  # Marina staging directory for DB dumps
  marina-staging:
    driver: local

  # PostgreSQL data volume (backed up via DB dump, not volume backup)
  postgres-data:
    driver: local

  # Redis data volume (backed up via RDB copy)
  redis-data:
    driver: local

  # Application uploads volume with backup labels
  app-uploads:
    driver: local
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.schedule: "0 3 * * *"  # 3:00 AM daily
      eu.polarnight.marina.destination: "hetzner-s3"
      eu.polarnight.marina.retention: "14d:8w:12m"  # Keep more for user data
      eu.polarnight.marina.paths: "/"
      eu.polarnight.marina.stopAttached: "true"  # Stop app container during backup
      eu.polarnight.marina.tags: "type:uploads,env:production"
      eu.polarnight.marina.exclude: "*.tmp,cache/*,thumbnails/*"

  # Application config volume with backup but no container stop
  app-config:
    driver: local
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.schedule: "0 5 * * *"  # 5:00 AM daily
      eu.polarnight.marina.destination: "hetzner-s3"
      eu.polarnight.marina.retention: "30d:12w:12m"  # Keep config longer
      eu.polarnight.marina.paths: "/"
      eu.polarnight.marina.stopAttached: "false"  # Config can be backed up live
      eu.polarnight.marina.tags: "type:config,env:production"

networks:
  backup-net:
    driver: bridge
  app-net:
    driver: bridge
