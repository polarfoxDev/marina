services:
  # Marina backup orchestrator
  marina:
    image: ghcr.io/polarfoxdev/marina:latest
    # build: .
    container_name: marina
    restart: unless-stopped
    volumes:
      # Docker socket access for discovery and container control
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Staging directory for DB dumps and volume copies (must be writable)
      - ./staging:/backup
      # Persistent data directory for logs and status database
      - marina-data:/var/lib/marina
      # Configuration file (defaults to /config.yml, override with CONFIG_FILE env var if needed)
      - ./config.yml:/config.yml:ro
      # SSH keys for SFTP backend support (optional, only if using sftp: repository)
      # Ensure keys have proper permissions: chmod 600 id_rsa, chmod 644 id_rsa.pub, chmod 644 known_hosts
      # - ./ssh-keys:/root/.ssh:ro
    ports:
      # Expose API server for status queries and future web UI
      - "8080:8080"
    environment:
      # Environment variables that can be referenced in config.yml
      # using ${VAR_NAME} or $VAR_NAME syntax
      RESTIC_PASSWORD: "${RESTIC_PASSWORD}"
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
      DO_SPACES_KEY: "${DO_SPACES_KEY}"
      DO_SPACES_SECRET: "${DO_SPACES_SECRET}"
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      # Marina runtime configuration (optional overrides)
      # CONFIG_FILE: "/config.yml"  # Default, no need to set unless using custom path
      DB_PATH: "/var/lib/marina/marina.db"
      API_PORT: "8080"
      NODE_NAME: "${HOSTNAME}"
    networks:
      - backup-net

  # Example: PostgreSQL database
  # No labels needed - configure in config.yml instead
  postgres:
    image: postgres:16-alpine
    container_name: app-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: myapp
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      # Required for pg_dumpall to authenticate
      PGPASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - backup-net
      - app-net

  # Example: MySQL database
  # No labels needed - configure in config.yml instead
  mysql:
    image: mysql:8.4
    container_name: app-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: myapp
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - backup-net
      - app-net

  # Example: MariaDB database
  # No labels needed - configure in config.yml instead
  mariadb:
    image: mariadb:11
    container_name: app-mariadb
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      MARIADB_DATABASE: myapp
    volumes:
      - mariadb-data:/var/lib/mysql
    networks:
      - backup-net
      - app-net

  # Example: Application with volumes
  # No labels needed - configure volumes in config.yml instead
  app:
    image: myapp:latest
    container_name: myapp
    restart: unless-stopped
    volumes:
      - app-uploads:/app/uploads
      - app-config:/app/config
    depends_on:
      - postgres
    networks:
      - app-net

volumes:
  # PostgreSQL data volume (backed up via DB dump, not volume backup)
  postgres-data:
    driver: local

  # MySQL data volume (backed up via DB dump, not volume backup)
  mysql-data:
    driver: local

  # MariaDB data volume (backed up via DB dump, not volume backup)
  mariadb-data:
    driver: local

  # Application uploads volume - configure in config.yml
  app-uploads:
    driver: local

  # Application config volume - configure in config.yml
  app-config:
    driver: local

  # Marina data volume for persistent storage
  marina-data:
    driver: local

networks:
  backup-net:
    driver: bridge
  app-net:
    driver: bridge

# Note: All backup targets are now configured in config.yml instead of Docker labels.
# See config.example.yml for examples of how to configure volume and database backups.
