services:
  marina:
    image: marina:latest
    container_name: marina-it
    user: "0:0" # run as root in integration to initialize /backup repo
    restart: unless-stopped
    environment:
      - CONFIG_FILE=/config/config.yml
      - STAGING_DIR=/backup/tmp
      - VOLUME_ROOT=/var/lib/docker/volumes
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes:ro
      - staging:/backup
      - ./config.yml:/config/config.yml:ro
    depends_on:
      - postgres
      - mysql
      - mariadb
      - mongo
      - redis
      - volume-writer

  postgres:
    image: postgres:16-alpine
    container_name: pg-it
    environment:
      - POSTGRES_PASSWORD=pgpass
      - POSTGRES_DB=testdb
      - POSTGRES_USER=postgres
    volumes:
      - staging:/backup
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.db: "postgres"
      eu.polarnight.marina.destination: "local-integration"
      eu.polarnight.marina.schedule: "* * * * *"
      eu.polarnight.marina.dump.args: "-U,postgres,-h,127.0.0.1,-d,testdb"

  mysql:
    image: mysql:8.4
    container_name: mysql-it
    environment:
      - MYSQL_ROOT_PASSWORD=mysqlpass
    command: ["--default-authentication-plugin=mysql_native_password"]
    volumes:
      - staging:/backup
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.db: "mysql"
      eu.polarnight.marina.destination: "local-integration"
      eu.polarnight.marina.schedule: "* * * * *"
      eu.polarnight.marina.dump.args: "-uroot,-pmysqlpass,--all-databases"

  mariadb:
    image: mariadb:11
    container_name: mariadb-it
    environment:
      - MARIADB_ROOT_PASSWORD=maripass
    volumes:
      - staging:/backup
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.db: "mariadb"
      eu.polarnight.marina.destination: "local-integration"
      eu.polarnight.marina.schedule: "* * * * *"
      eu.polarnight.marina.dump.args: "-uroot,-pmaripass,--all-databases"

  mongo:
    image: mongo:7
    container_name: mongo-it
    command: ["--quiet"]
    volumes:
      - staging:/backup
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.db: "mongo"
      eu.polarnight.marina.destination: "local-integration"
      eu.polarnight.marina.schedule: "* * * * *"

  redis:
    image: redis:7-alpine
    container_name: redis-it
    volumes:
      - staging:/backup
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.db: "redis"
      eu.polarnight.marina.destination: "local-integration"
      eu.polarnight.marina.schedule: "* * * * *"

  volume-writer:
    image: alpine:3.20
    container_name: volwriter-it
    command: ["sh", "-lc", "printf 'hello-%s' $(date +%s) > /mnt/data/hello.txt && sleep infinity"]
    volumes:
      - testdata:/mnt/data

volumes:
  staging:
  testdata:
    labels:
      eu.polarnight.marina.enabled: "true"
      eu.polarnight.marina.destination: "local-integration"
      eu.polarnight.marina.schedule: "* * * * *"
      eu.polarnight.marina.paths: "/"
      eu.polarnight.marina.retention: "1d:1w:1m"
      eu.polarnight.marina.stopAttached: "false"
