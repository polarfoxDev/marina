services:
  marina:
    image: marina:latest
    container_name: marina-it
    # user: "0:0" # run as root in integration to initialize /backup repo
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - CONFIG_FILE=/config/config.yml
      - API_PORT=8080
      - NODE_NAME=integration-server
      - MARINA_AUTH_PASSWORD=integration
    volumes:
      - data:/var/lib/marina/
            - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./staging:/backup
      - ./config.yml:/app/config.yml:ro
    depends_on:
      - postgres
      - mysql
      - mariadb
      - mongo
      - volume-writer
    networks:
      - mesh

  postgres:
    image: postgres:16-alpine
    container_name: pg-it
    environment:
      - POSTGRES_PASSWORD=pgpass
      - POSTGRES_DB=testdb
      - POSTGRES_USER=postgres
      - PGPASSWORD=pgpass
    labels:
      dev.polarfox.marina.enabled: "true"
      dev.polarfox.marina.db: "postgres"
      dev.polarfox.marina.instanceID: "local-integration"
      # dev.polarfox.marina.dump.args: "-U,postgres,-h,127.0.0.1,-d,testdb"

  mysql:
    image: mysql:8.4
    container_name: mysql-it
    environment:
      - MYSQL_ROOT_PASSWORD=mysqlpass
    labels:
      dev.polarfox.marina.enabled: "true"
      dev.polarfox.marina.db: "mysql"
      dev.polarfox.marina.instanceID: "local-integration"

  mariadb:
    image: mariadb:11
    container_name: mariadb-it
    environment:
      - MARIADB_ROOT_PASSWORD=maripass
    labels:
      dev.polarfox.marina.enabled: "true"
      dev.polarfox.marina.db: "mariadb"
      dev.polarfox.marina.instanceID: "local-integration"
      dev.polarfox.marina.pre: "mariadb -uroot -pmaripass -e 'CREATE DATABASE IF NOT EXISTS createdbeforefirstdump;'"
      dev.polarfox.marina.post: "mariadb -uroot -pmaripass -e 'CREATE DATABASE IF NOT EXISTS createdafterfirstdump;'"

  mongo:
    image: mongo:7
    container_name: mongo-it
    command: ["--quiet"]
    labels:
      dev.polarfox.marina.enabled: "true"
      dev.polarfox.marina.db: "mongo"
      dev.polarfox.marina.instanceID: "local-integration"

  volume-writer:
    image: alpine:3.20
    container_name: volwriter-it
    command: ["sh", "-lc", "printf 'hello-%s' $(date +%s) > /mnt/data/hello.txt && dd if=/dev/urandom of=/mnt/data/random.bin bs=1M count=100 && sleep infinity"]
    volumes:
      - testdata:/mnt/data

volumes:
  data:
  testdata:
    labels:
      dev.polarfox.marina.enabled: "true"
      dev.polarfox.marina.instanceID: "local-integration"
      dev.polarfox.marina.paths: "/"
      dev.polarfox.marina.stopAttached: "true"

networks:
  mesh:
    external: true