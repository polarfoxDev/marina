services:
  marina:
    image: marina:latest
    container_name: marina-it
    # user: "0:0" # run as root in integration to initialize /backup repo
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - CONFIG_FILE=/config/config.yml
      - API_PORT=8080
      - NODE_NAME=integration-server
      - MARINA_AUTH_PASSWORD=integration
    volumes:
      - data:/var/lib/marina/
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - repo:/repo
      - ./staging:/backup
      - ./config.yml:/config/config.yml:ro
    depends_on:
      - postgres
      - mysql
      - mariadb
      - mongo
      - postgres-empty
      - volume-writer
      - volume-writer-empty
    networks:
      - mesh

  postgres:
    image: postgres:16-alpine
    container_name: pg-it
    environment:
      - POSTGRES_PASSWORD=pgpass
      - POSTGRES_DB=testdb
      - POSTGRES_USER=postgres
      - PGPASSWORD=pgpass

  mysql:
    image: mysql:8.4
    container_name: mysql-it
    environment:
      - MYSQL_ROOT_PASSWORD=mysqlpass

  mariadb:
    image: mariadb:11
    container_name: mariadb-it
    environment:
      - MARIADB_ROOT_PASSWORD=maripass

  mongo:
    image: mongo:7
    container_name: mongo-it
    command: ["--quiet"]

  # Empty database container - should fail validation and be excluded from backups
  # Pre-hook creates a fake pg_dumpall that outputs nothing, simulating a silent dump failure
  postgres-empty:
    image: postgres:16-alpine
    container_name: pg-empty-it
    environment:
      - POSTGRES_PASSWORD=pgpass
      - POSTGRES_DB=testdb
      - POSTGRES_USER=postgres
      - PGPASSWORD=pgpass

  volume-writer:
    image: alpine:3.20
    container_name: volwriter-it
    command: ["sh", "-lc", "echo 'volume test data' > /mnt/data/test.txt && dd if=/dev/urandom of=/mnt/data/random.bin bs=1M count=100 && sleep infinity"]
    volumes:
      - testdata:/mnt/data

  # Empty volume writer - should fail validation and be excluded from backups
  volume-writer-empty:
    image: alpine:3.20
    container_name: volwriter-empty-it
    command: ["sh", "-lc", "touch /mnt/data/empty.txt && sleep infinity"]
    volumes:
      - testdata-empty:/mnt/data

volumes:
  data:
  repo:
  testdata:
  testdata-empty:

networks:
  mesh:
    external: true