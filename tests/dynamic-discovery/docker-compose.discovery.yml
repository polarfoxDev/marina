services:
  marina:
    image: marina:discoverytest
    container_name: marina
    restart: unless-stopped
    user: "0:0"  # Run as root for Docker socket access (development only)
    volumes:
      # Docker socket access for discovery and container control
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Volume root for direct filesystem access
      - /var/lib/docker/volumes:/var/lib/docker/volumes:ro
      # Staging directory for DB dumps (must be writable)
      - marina-staging:/backup/tmp
      # Local backup repository directory
      - marina-backup:/backup/restic
      # Configuration file
      - ./config.yml:/app/config.yml:ro
    environment:
      # Marina runtime configuration
      CONFIG_FILE: "/app/config.yml"
      VOLUME_ROOT: "/var/lib/docker/volumes"
      STAGING_DIR: "/backup/tmp"
      # Dynamic discovery settings
      DISCOVERY_INTERVAL: "30s"
      ENABLE_EVENTS: "true"
      # Restic password for local backup (used in config.example.yml)
      RESTIC_PASSWORD: "${RESTIC_PASSWORD:-changeme}"

volumes:
  marina-staging:
  marina-backup:
